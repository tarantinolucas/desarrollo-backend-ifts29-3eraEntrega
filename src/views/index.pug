doctype html
html(lang='es')
  head
    meta(charset='UTF-8')
    meta(name='viewport', content='width=device-width, initial-scale=1.0')
    title= title
    link(rel='stylesheet', href='https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap')
    link(rel='stylesheet', href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css')
    style.
      body {
        font-family: 'Inter', sans-serif;
        margin: 0;
        padding: 24px;
        background: linear-gradient(135deg, #f6fbff, #e9f6ff);
        color: #0f4c81;
        display: flex;
        min-height: 100vh;
      }

      .sidebar {
        width: 80px;
        background: linear-gradient(180deg, rgba(6,40,60,0.95), rgba(5,34,54,0.95));
        color: white;
        border-radius: 12px;
        padding: 20px 12px;
        display:flex;
        flex-direction: column;
        align-items: center;
        gap: 18px;
        box-shadow: 0 12px 30px rgba(2,6,23,0.12);
        position: sticky;
        top: 24px;
        height: calc(100vh - 48px);
      }

      .logo {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        background: linear-gradient(135deg,#0b74b6,#0b4fa0);
        display:flex;
        align-items:center;
        justify-content:center;
        font-weight:700;
      }

      .sidebar nav a {
        width: 52px;
        height: 52px;
        border-radius: 10px;
        display:flex;
        align-items:center;
        justify-content:center;
        color: rgba(255,255,255,0.9);
        text-decoration: none;
        font-size: 1.2em;
        transition: transform .18s ease, box-shadow .18s ease;
      }
      .sidebar nav a:hover {
        transform: translateY(-6px);
        box-shadow: 0 10px 26px rgba(4,30,60,0.28);
      }

      .main {
        flex: 1;
        margin-left: 24px;
      }

      .container {
        background: rgba(255,255,255,0.75);
        padding: 28px;
        border-radius: 16px;
        box-shadow: 0 14px 40px rgba(2,6,23,0.08);
      }

      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 28px;
      }

      .header-left h1 {
        font-size: 2.5rem;
        margin: 4px 0;
      }

      .header-left .clinic-name {
        font-size: 1rem;
        color: #5b7f98;
        margin: 0 0 4px 0;
      }

      .header-left .page-sub {
        font-size: 1rem;
        color: #5b7f98;
        margin: 4px 0;
      }

      .user-section {
        display: flex;
        flex-direction: column;
        gap: 12px;
        align-items: flex-end;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 12px;
        background: white;
        padding: 10px 16px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(12,50,80,0.06);
      }

      .user-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: linear-gradient(135deg, #0b74b6, #0b4fa0);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 1.1rem;
        flex-shrink: 0;
      }

      .user-details {
        display: flex;
        flex-direction: column;
      }

      .user-name {
        font-weight: 600;
        color: #0f4c81;
        font-size: 0.95rem;
        margin: 0;
      }

      .user-role {
        font-size: 0.8rem;
        color: #5b7f98;
        margin: 2px 0 0 0;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .role-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .role-badge.admin {
        background: linear-gradient(135deg, rgba(239,68,68,0.1), rgba(220,38,38,0.1));
        color: #991b1b;
      }

      .role-badge.medico {
        background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(5,150,105,0.1));
        color: #065f46;
      }

      .role-badge.paciente {
        background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(37,99,235,0.1));
        color: #1e3a8a;
      }

      .logout-btn {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.18s ease;
        box-shadow: 0 4px 12px rgba(239,68,68,0.2);
      }

      .logout-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(239,68,68,0.3);
      }

      .logout-btn:active {
        transform: translateY(0);
      }

      .top-grid {
        display:grid;
        grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
        gap: 16px;
        margin-top: 22px;
      }

      .metric-card {
        background: linear-gradient(135deg, rgba(239,250,255,0.9), rgba(221,238,255,0.9));
        padding: 18px;
        border-radius: 12px;
        display:flex;
        align-items:center;
        justify-content: space-between;
        border: 1px solid rgba(12,50,80,0.04);
      }

      .metric-left {
        display:flex;
        gap:12px;
        align-items:center;
      }
      .metric-icon {
        width:48px;
        height:48px;
        border-radius:10px;
        display:flex;
        align-items:center;
        justify-content:center;
        background: rgba(11,117,182,0.1);
        color: #0f4c81;
        font-size:1.3em;
      }
      .metric-title { font-size:0.85em; color: #5b7f98; margin:0; }
      .metric-number { font-size:1.6rem; font-weight:700; color: #0f4c81; margin:0; }

      .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-top: 28px;
      }

      .info-card {
        background: white;
        padding: 14px;
        border-radius: 12px;
        box-shadow: 0 8px 22px rgba(12,50,80,0.04);
      }

      .info-card h3 {
        margin: 0 0 10px 0;
        font-size: 1rem;
        color: #0f4c81;
        display:flex;
        align-items:center;
        gap:10px;
      }

      ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      li {
        background: linear-gradient(180deg, #ffffff, #fbfdff);
        border-radius: 10px;
        margin-bottom: 10px;
        padding: 10px 12px;
        border: 1px solid rgba(10,60,100,0.03);
      }

      @media (max-width: 968px) {
        .page-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 16px;
        }

        .user-section {
          width: 100%;
          justify-content: space-between;
        }
      }

  body
    .sidebar
      .logo SI
      nav
        a(href='/' title='Inicio')
          i.fas.fa-house
        if !user || user.role === 'Administrativo'
          a(href='/pacientes' title='Pacientes')
            i.fas.fa-user-injured
          a(href='/medicos' title='Médicos')
            i.fas.fa-user-md
          a(href='/turnos' title='Turnos')
            i.fas.fa-calendar-check
        if user && user.role === 'Administrativo'
          a(href='/usuarios' title='Usuarios')
            i.fas.fa-users-cog
        else if user && user.role === 'Medico'
          a(href='/pacientes' title='Pacientes')
            i.fas.fa-user-injured
        else if user && user.role === 'Paciente'
          a(href='/turnos' title='Turnos')
            i.fas.fa-calendar-check

    .main
      .container
        .page-header
          .header-left
            p.clinic-name Clínica Salud Integral
            h1.page-title Dashboard
            p.page-sub Desarrollo Backend - Grupo 4
          
          if user
            .user-section
              .user-info
                .user-avatar= user.username.charAt(0).toUpperCase()
                .user-details
                  p.user-name Bienvenido, #{user.username}
                  p.user-role
                    if user.role === 'Administrativo'
                      span.role-badge.admin
                        i.fas.fa-user-shield
                        | Administrativo
                    else if user.role === 'Medico'
                      span.role-badge.medico
                        i.fas.fa-user-md
                        | Médico
                    else if user.role === 'Paciente'
                      span.role-badge.paciente
                        i.fas.fa-user
                        | Paciente
              button.logout-btn(onclick='logout()')
                i.fas.fa-sign-out-alt
                | Cerrar Sesión
          else
            a(href='/login' style='padding: 10px 20px; background: linear-gradient(135deg, #0b74b6, #0b4fa0); color: white; text-decoration: none; border-radius: 10px; font-weight: 600;') Iniciar sesión

        .top-grid
          .metric-card
            .metric-left
              .metric-icon
                i.fas.fa-calendar-check
              .metric-data
                p.metric-title Turnos (últ. 7 días)
                p.metric-number= metrics.turnos
          .metric-card
            .metric-left
              .metric-icon
                i.fas.fa-user-injured
              .metric-data
                p.metric-title Pacientes registrados
                p.metric-number= metrics.pacientes
          .metric-card
            .metric-left
              .metric-icon
                i.fas.fa-user-md
              .metric-data
                p.metric-title Médicos activos
                p.metric-number= metrics.medicos

        .info-grid
          .info-card
            h3
              i.fas.fa-list-ul
              | Turnos agendados recientemente
            if turnos.length
              ul
                each t in turnos  
                  li              
                    strong= `${t.fechaFormateada} ${t.HoraInicio || ''} - ${t.HoraFin || ''}`
                    br
                    span Paciente: #{t.Paciente}
                    br
                    span Médico: #{t.Medico}
            else
              p No hay turnos recientes

          .info-card
            h3
              i.fas.fa-users
              | Pacientes registrados recientemente
            if pacientes.length
              ul
                each p in pacientes
                  li
                    strong= `${p.Nombre || p.nombre} ${p.Apellido || p.apellido}`
                    br
                    span DNI: #{p.DNI || p.dni || '-'} · Obra Social: #{p.ObraSocial || p.obraSocial || '-'}
            else
              p No hay pacientes registrados

    script.
      async function logout(){
        try {
          const response = await fetch('/api/auth/logout', { method: 'POST' });
          const data = await response.json();
          if (response.ok) {
            localStorage.removeItem('authToken');
            window.location.href = '/login';
          } else {
            alert(data.message || 'Error al cerrar sesión');
          }
        } catch (e) {
          alert('Error de conexión: ' + e.message);
        }
      }