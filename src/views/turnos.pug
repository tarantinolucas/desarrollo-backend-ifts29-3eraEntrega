doctype html
html(lang='es')
  head
    meta(charset='UTF-8')
    meta(name='viewport', content='width=device-width, initial-scale=1.0')
    title= title
    link(rel='stylesheet', href='https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap')
    link(rel='stylesheet', href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css')
    include partials/layoutStyles.pug
    include partials/headerModule.pug

    //- --- ESTILOS UNIFICADOS (Basados en el Dashboard) ---
    style.
      /* --- Estilos de Acciones (Re-diseñados como Tarjetas Métricas) --- */
      .actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin: 30px 0;
      }
      .action-button {
        background: linear-gradient(135deg, #ffffff 0%, #f8fbff 100%);
        padding: 24px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        gap: 16px;
        border: 1px solid rgba(12,50,80,0.08);
        box-shadow: 0 4px 16px rgba(12,50,80,0.06);
        transition: all 0.3s ease;
        text-decoration: none;
      }
      .action-button:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(12,50,80,0.12);
        color: #0f4c81;
      }
      .action-icon {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        flex-shrink: 0;
      }
      .action-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #0f4c81;
        margin: 0;
      }
      /* Colores de íconos de acción */
      .action-button.create .action-icon {
        background: linear-gradient(135deg, rgba(72,187,120,0.15), rgba(56,161,105,0.1));
        color: #38a169;
      }
      .action-button.read .action-icon {
        background: linear-gradient(135deg, rgba(66,153,225,0.15), rgba(49,130,206,0.1));
        color: #3182ce;
      }
      .action-button.update .action-icon {
        background: linear-gradient(135deg, rgba(237,137,54,0.15), rgba(221,107,32,0.1));
        color: #dd6b20;
      }
      .action-button.delete .action-icon {
        background: linear-gradient(135deg, rgba(245,101,101,0.15), rgba(229,62,62,0.1));
        color: #e53e3e;
      }

      /* --- Estilos de Formularios (Re-diseñados como Info-Card) --- */
      .form-section {
        background: white;
        padding: 0;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(12,50,80,0.06);
        overflow: hidden;
        margin: 20px 0;
        display: none; /* Oculto por defecto */
      }
      .form-section.active {
        display: block; /* Visible con clase 'active' */
      }
      .form-section .info-card-header {
        padding: 20px 24px;
        background: linear-gradient(135deg, #f8fbff 0%, #ffffff 100%);
        border-bottom: 1px solid rgba(12,50,80,0.06);
      }
      .form-section h3 {
        margin: 0;
        font-size: 1.1rem;
        color: #0f4c81;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 600;
      }
      .form-section h3 i { font-size: 1.2em; opacity: 0.8; }
      .form-content {
        padding: 24px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #2d3748;
        font-size: 0.9rem;
      }
      .form-group input, .form-group select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #cbd5e0;
        border-radius: 8px;
        font-size: 1rem;
        box-sizing: border-box;
      }
      .form-group input:focus, .form-group select:focus {
        outline: none;
        border-color: #0b74b6;
        box-shadow: 0 0 0 3px rgba(11, 116, 182, 0.1);
      }
      .submit-button { /* Botón unificado */
        background: #0b74b6;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-top: 10px;
        margin-bottom: 10px;
      }
      .submit-button:hover {
        background: #0b4fa0;
        box-shadow: 0 4px 12px rgba(11, 116, 182, 0.2);
      }
      .form-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: flex-end;
      }
      hr.form-divider {
        border: none;
        border-top: 1px solid #e2e8f0;
        margin: 24px 0;
      }
      /* Específico de este formulario */
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }
      @media (max-width: 600px) {
        .form-row { grid-template-columns: 1fr; }
      }

      /* --- Estilos de Resultados (Unificados) --- */
      .result {
        padding: 15px 24px;
        border-radius: 0;
        margin: 0;
        display: none;
        font-weight: 500;
      }
      .result i { margin-right: 8px; }
      .result.success {
        background: #f0fff4;
        border-top: 1px solid rgba(72, 187, 120, 0.2);
        color: #2f855a;
      }
      .result.success i { color: #48bb78; }
      .result.error {
        background: #fff5f5;
        border-top: 1px solid rgba(229, 62, 62, 0.2);
        color: #c53030;
      }
      .result.error i { color: #f56565; }
      
      .result-grid-container {
        padding: 24px;
        background: #f8fbff;
      }
      .result-grid-container h4 {
        margin: 0 0 16px 0;
        color: #0f4c81;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      /* --- Estilos de Tarjetas (Unificados con Dashboard) --- */
      .cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
      }
      .card {
        background: linear-gradient(135deg, #ffffff 0%, #fbfdff 100%);
        border-radius: 14px;
        border: 1px solid rgba(10,60,100,0.08);
        box-shadow: 0 2px 12px rgba(12,50,80,0.04);
        overflow: hidden;
        transition: all 0.3s ease;
      }
      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(12,50,80,0.1);
      }
      .card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #0f4c81;
        font-weight: 600;
        padding: 14px 18px;
        border-bottom: 1px solid rgba(12,50,80,0.06);
      }
      .card-header i { font-size: 1.1em; }
      .card-title { font-size: 0.98rem; margin: 0; }
      .card-body {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 18px;
      }
      .card-body p {
        margin: 0;
        color: #5b7f98;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.92rem;
      }
      .card-body p i {
        color: #0f4c81;
        opacity: 0.7;
        width: 16px;
      }
      .card.turno-card:hover {
        cursor: pointer;
        border-color: #0b74b6;
      }
      .page-sub {
        font-size: 1rem;
        color: #5b7f98;
        margin: 4px 0;
      }

  body
    include partials/sidebar.pug
    +sidebar(user, 'turnos')

    .main
      .container
        +pageHeader(user, 'Gestión de Turnos')
        
        //- --- Botones de Acción (Re-diseñados) ---
        .actions
          if !user || user.role === 'Administrativo'
            a.action-button.create(href='#' onclick='showForm("create")')
              .action-icon
                i.fas.fa-plus-circle
              .action-title Crear Turno
            a.action-button.read(href='#' onclick='showForm("read")')
              .action-icon
                i.fas.fa-search
              .action-title Consultar
            a.action-button.update(href='#' onclick='showForm("update")')
              .action-icon
                i.fas.fa-edit
              .action-title Modificar
            a.action-button.delete(href='#' onclick='showForm("delete")')
              .action-icon
                i.fas.fa-trash-alt
              .action-title Eliminar
          else if user && user.role === 'Medico'
            a.action-button.read(href='#' onclick='showForm("read")')
              .action-icon
                i.fas.fa-search
              .action-title Consultar Turnos
          else if user && user.role === 'Paciente'
            a.action-button.read(href='#' onclick='showForm("read")')
              .action-icon
                i.fas.fa-search
              .action-title Mis Turnos
      
        //- --- Formularios (Re-diseñados como .info-card) ---
        
        // Formulario Crear Turno
        .form-section#create-form
          .info-card-header
            h3
              i.fas.fa-plus-circle
              | Crear Nuevo Turno
          .form-content
            form(onsubmit='createTurno(event)')
              .form-group
                label(for='fecha') Fecha:
                input(type='date' id='fecha' name='fecha' required)
              .form-row
                .form-group
                  label(for='horaInicio') Hora de Inicio:
                  input(type='time' id='horaInicio' name='horaInicio' required)
                .form-group
                  label(for='horaFin') Hora de Fin:
                  input(type='time' id='horaFin' name='horaFin' required)
              .form-group
                label(for='idPaciente') Paciente:
                select(id='idPaciente' name='idPaciente' required)
                  option(value='') Seleccionar paciente...
              .form-group
                label(for='idMedico') Médico:
                select(id='idMedico' name='idMedico' required)
                  option(value='') Seleccionar médico...
              button.submit-button(type='submit') Crear Turno
          .result#create-result
        
        // Formulario Consultar Turnos
        .form-section#read-form
          .info-card-header
            h3
              i.fas.fa-search
              | Consultar Turnos
          .form-content
            if user && user.role === 'Administrativo'
              .form-actions
                button.submit-button(onclick='getAllTurnos()') Ver Todos
              hr.form-divider
            .form-actions
              .form-group(style='margin-bottom:0; flex-grow:1;')
                label(for='searchFecha') Buscar por Fecha:
                input(type='date' id='searchFecha' name='searchFecha')
              button.submit-button(onclick='getTurnosByFecha()') Buscar
            if user && user.role === 'Administrativo'
              hr.form-divider
              .form-actions
                .form-group(style='margin-bottom:0; flex-grow:1;')
                  label(for='searchPaciente') Buscar por Paciente:
                  select(id='searchPaciente' name='searchPaciente')
                    option(value='') Seleccionar paciente...
                button.submit-button(onclick='getTurnosByPaciente()') Buscar
              hr.form-divider
              .form-actions
                .form-group(style='margin-bottom:0; flex-grow:1;')
                  label(for='searchMedico') Buscar por Médico:
                  select(id='searchMedico' name='searchMedico')
                    option(value='') Seleccionar médico...
                button.submit-button(onclick='getTurnosByMedico()') Buscar
            else
              p.page-sub(style='margin-top:20px;') Tus turnos se mostrarán automáticamente.
          .result#read-result
        
        // Formulario Modificar Turno
        .form-section#update-form
          .info-card-header
            h3
              i.fas.fa-edit
              | Modificar Turno
          .form-content
            .form-group
              label(for='updateTurnoSelect') Seleccionar Turno:
              select(id='updateTurnoSelect' name='updateTurnoSelect' required)
                option(value='') Seleccionar turno...
            button.submit-button(onclick='loadTurnoData()') Cargar Datos
            
            form(onsubmit='updateTurno(event)' style='display:none' id='update-data-form')
              hr.form-divider
              .form-group
                label(for='updateFecha') Fecha:
                input(type='date' id='updateFecha' name='updateFecha' required)
              .form-row
                .form-group
                  label(for='updateHoraInicio') Hora de Inicio:
                  input(type='time' id='updateHoraInicio' name='updateHoraInicio' required)
                .form-group
                  label(for='updateHoraFin') Hora de Fin:
                  input(type='time' id='updateHoraFin' name='updateHoraFin' required)
              .form-group
                label(for='updateIdPaciente') Paciente:
                select(id='updateIdPaciente' name='updateIdPaciente' required)
                  option(value='') Seleccionar paciente...
              .form-group
                label(for='updateIdMedico') Médico:
                select(id='updateIdMedico' name='updateIdMedico' required)
                  option(value='') Seleccionar médico...
              button.submit-button(type='submit') Actualizar Turno
          .result#update-result
        
        // Formulario Eliminar Turno
        .form-section#delete-form
          .info-card-header
            h3
              i.fas.fa-trash-alt
              | Eliminar Turno
          .form-content
            .form-group
              label(for='deleteTurnoSelect') Seleccionar Turno a Eliminar:
              select(id='deleteTurnoSelect' name='deleteTurnoSelect' required)
                option(value='') Seleccionar turno...
            button.submit-button(onclick='deleteTurnoFromSelect()' style='background:#e53e3e;') Eliminar Turno Seleccionado
          .result#delete-result

    //- --- SCRIPT REFACTORIZADO (Modificado para renderizar en contenedores) ---
    script.
      let pacientes = [];
      let medicos = [];
      const currentUserRole = '#{user ? user.role : ''}';
      const currentPacienteId = '#{user && user.pacienteId ? user.pacienteId : ''}';
      const currentMedicoId = '#{user && user.medicoId ? user.medicoId : ''}';

      // Cargar datos iniciales
      window.onload = async function() {
        await loadPacientes();
        await loadMedicos();
        setMinDateTime();
        // Solo el administrativo necesita los dropdowns de actualización/eliminación
        if (currentUserRole === 'Administrativo') {
          await loadTurnosDropdown('updateTurnoSelect');
          await loadTurnosDropdown('deleteTurnoSelect');
        }
        if (currentUserRole === 'Paciente' && currentPacienteId) {
          showForm('read');
          await getTurnosByPacienteId(currentPacienteId);
        } else if (currentUserRole === 'Medico' && currentMedicoId) {
          showForm('read');
          await getTurnosByMedicoId(currentMedicoId);
        }
      };

      function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        const dia = String(date.getUTCDate()).padStart(2, '0');
        const mes = String(date.getUTCMonth() + 1).padStart(2, '0');
        const anio = date.getUTCFullYear();
        return `${dia}/${mes}/${anio}`;
      }

      function setMinDateTime() {
        const today = new Date().toISOString().split('T')[0];
        const fechaInputs = ['fecha', 'updateFecha', 'searchFecha'];
        fechaInputs.forEach(id => {
          const input = document.getElementById(id);
          if (input) {
            input.min = today;
          }
        });
      }

      function validateDateTime(fecha, hora) {
        if (!fecha || !hora) return true;
        const fechaHoraTurno = new Date(`${fecha}T${hora}:00`);
        const ahora = new Date();
        return fechaHoraTurno > ahora;
      }

      async function loadPacientes() {
        try {
          const response = await fetch('/api/pacientes');
          const result = await response.json();
          if (response.ok) {
            pacientes = result.data;
            updatePacienteSelects();
          }
        } catch (error) {
          console.error('Error cargando pacientes:', error);
        }
      }

      async function loadMedicos() {
        try {
          const response = await fetch('/api/medicos');
          const result = await response.json();
          if (response.ok) {
            medicos = result.data;
            updateMedicoSelects();
          }
        } catch (error) {
          console.error('Error cargando médicos:', error);
        }
      }

      async function ensurePacientesLoaded() {
        if (!Array.isArray(pacientes) || pacientes.length === 0) {
          try {
            const response = await fetch('/api/pacientes');
            const result = await response.json();
            if (response.ok) {
              pacientes = result.data;
              updatePacienteSelects();
            }
          } catch (error) {
            console.error('Error cargando pacientes:', error);
          }
        }
      }

      async function ensureMedicosLoaded() {
        if (!Array.isArray(medicos) || medicos.length === 0) {
          try {
            const response = await fetch('/api/medicos');
            const result = await response.json();
            if (response.ok) {
              medicos = result.data;
              updateMedicoSelects();
            }
          } catch (error) {
            console.error('Error cargando médicos:', error);
          }
        }
      }

      function updatePacienteSelects() {
        const selects = ['idPaciente', 'searchPaciente', 'updateIdPaciente'];
        selects.forEach(selectId => {
          const select = document.getElementById(selectId);
          if (select) {
            const defaultOption = select.querySelector('option[value=""]');
            select.innerHTML = '';
            if (defaultOption) {
              select.appendChild(defaultOption);
            }
            pacientes.forEach(paciente => {
              const id = paciente._id || paciente.IdPaciente;
              const option = document.createElement('option');
              option.value = id;
              option.textContent = `${paciente.Nombre} ${paciente.Apellido} (DNI: ${paciente.DNI})`;
              select.appendChild(option);
            });
          }
        });
      }

      function updateMedicoSelects() {
        const selects = ['idMedico', 'searchMedico', 'updateIdMedico'];
        selects.forEach(selectId => {
          const select = document.getElementById(selectId);
          if (select) {
            const defaultOption = select.querySelector('option[value=""]');
            select.innerHTML = '';
            if (defaultOption) {
              select.appendChild(defaultOption);
            }
            medicos.forEach(medico => {
              const id = medico._id || medico.IdMedico;
              const option = document.createElement('option');
              option.value = id;
              option.textContent = `${medico.Nombre} ${medico.Apellido} (${medico.Especialidad})`;
              select.appendChild(option);
            });
          }
        });
      }

      function showForm(formType) {
        const forms = document.querySelectorAll('.form-section');
        forms.forEach(form => form.classList.remove('active'));
        const target = document.getElementById(formType + '-form');
        if (!target) return;
        
        if (formType !== 'read' && currentUserRole !== 'Administrativo') {
          showResult('read-result', 'Acción no permitida para tu rol. Usa "Consultar Turnos" para ver tus turnos.', false);
          document.getElementById('read-form').classList.add('active');
          return;
        }
        target.classList.add('active');
        const results = document.querySelectorAll('.result');
        results.forEach(result => {
          result.style.display = 'none';
          result.innerHTML = '';
          result.className = 'result'; // Resetea clases
        });
      }

      function showResult(elementId, message, isSuccess = true) {
        const result = document.getElementById(elementId);
        const iconHtml = isSuccess ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-times-circle"></i>';
        result.innerHTML = `${iconHtml} ${message}`;
        result.className = 'result ' + (isSuccess ? 'success' : 'error');
        result.style.display = 'block';
      }
      
      // --- MODIFICADO: Muestra resultados en el contenedor de grilla ---
      function showCardResult(htmlContent, isSuccess = true) {
        const container = document.getElementById('read-result');
        container.className = 'result result-grid-container ' + (isSuccess ? 'success' : 'error');
        container.style.display = 'block';
        container.innerHTML = htmlContent;
      }

      async function createTurno(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = {
          Fecha: formData.get('fecha'),
          HoraInicio: formData.get('horaInicio'),
          HoraFin: formData.get('horaFin'),
          IdPaciente: formData.get('idPaciente'),
          IdMedico: formData.get('idMedico'),
        }
        if (!validateDateTime(data.Fecha, data.HoraInicio)) {
          showResult('create-result', 'La fecha y hora del turno deben ser posteriores al momento actual', false);
          return;
        }
        try {
          const response = await fetch('/api/turnos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          const result = await response.json();
          if (response.ok) {
            const id = result.data._id || result.data.IdTurno;
            showResult('create-result', `Turno creado exitosamente. ID: ${id}`, true);
            event.target.reset();
            loadTurnosDropdown('updateTurnoSelect');
            loadTurnosDropdown('deleteTurnoSelect');
          } else {
            showResult('create-result', `Error: ${result.message}`, false);
          }
        } catch (error) {
          showResult('create-result', `Error de conexión: ${error.message}`, false);
        }
      }

      async function getAllTurnos() {
        try {
          const response = await fetch('/api/turnos');
          const result = await response.json();
      
          let data = Array.isArray(result.data) ? result.data : [];
          if (currentUserRole === 'Paciente' && currentPacienteId) {
            data = data.filter(t => (t.IdPaciente == currentPacienteId));
          } else if (currentUserRole === 'Medico' && currentMedicoId) {
            data = data.filter(t => (t.IdMedico == currentMedicoId));
          }
      
          if (response.ok) {
            let html = `<h4><i class="fas fa-clipboard-list"></i> Lista de Turnos (${data.length}):</h4><div class="cards-grid">`;
            data.forEach(turno => {
              const medico = medicos.find(m => (m._id || m.IdMedico) == turno.IdMedico);
              const paciente = pacientes.find(p => (p._id || p.IdPaciente) == turno.IdPaciente);
              const medicoNombre = medico ? medico.Nombre + ' ' + medico.Apellido : (turno.Medico || 'N/A');
              const pacienteNombre = paciente ? paciente.Nombre + ' ' + paciente.Apellido : (turno.Paciente || 'N/A');
              html += `<div class="card turno-card" onclick="selectTurnoCard(this)" data-fecha="${formatDate(turno.Fecha)}" data-hora-inicio="${turno.HoraInicio || ''}" data-hora-fin="${turno.HoraFin || ''}" data-paciente="${pacienteNombre}" data-medico="${medicoNombre}">
                <div class="card-header">
                  <i class="fas fa-calendar-check"></i>
                  <div class="card-title">${formatDate(turno.Fecha)} ${turno.HoraInicio || ''}-${turno.HoraFin || ''}</div>
                </div>
                <div class="card-body">
                  <p><i class="fas fa-user-injured"></i> Paciente: ${pacienteNombre}</p>
                  <p><i class="fas fa-user-md"></i> Médico: ${medicoNombre}</p>
                </div>
              </div>`;
            });
            html += '</div>';
            showCardResult(html, true); // --- MODIFICADO ---
          } else {
            showResult('read-result', `Error: ${result.message}`, false);
          }
        } catch (error) {
          showResult('read-result', `Error de conexión: ${error.message}`, false);
        }
      }

      async function getTurnosByFecha() {
        const fecha = document.getElementById('searchFecha').value;
        if (!fecha) {
          showResult('read-result', 'Por favor seleccione una fecha', false);
          return;
        }
        try {
          const response = await fetch(`/api/turnos/fecha/${fecha}`);
          const result = await response.json();
          if (response.ok) {
            let html = `<h4><i class="fas fa-calendar-day"></i> Turnos del ${formatDate(fecha)}:</h4><div class="cards-grid">`;
            if (!result.data.length) {
              html += '<p>No hay turnos para esta fecha.</p>';
            }
            result.data.forEach(turno => {
              const paciente = pacientes.find(p => (p._id || p.IdPaciente) == turno.IdPaciente);
              const medico = medicos.find(m => (m._id || m.IdMedico) == turno.IdMedico);
              const medicoNombre = medico ? medico.Nombre + ' ' + medico.Apellido : 'N/A';
              const pacienteNombre = paciente ? paciente.Nombre + ' ' + paciente.Apellido : 'N/A';
              html += `<div class="card turno-card" onclick="selectTurnoCard(this)" data-fecha="${formatDate(turno.Fecha)}" data-hora-inicio="${turno.HoraInicio || ''}" data-hora-fin="${turno.HoraFin || ''}" data-paciente="${pacienteNombre}" data-medico="${medicoNombre}">
                <div class="card-header">
                  <i class="fas fa-calendar-check"></i>
                  <div class="card-title">${formatDate(turno.Fecha)} ${turno.HoraInicio || ''}-${turno.HoraFin || ''}</div>
                </div>
                <div class="card-body">
                  <p><i class="fas fa-user-injured"></i> Paciente: ${pacienteNombre}</p>
                  <p><i class="fas fa-user-md"></i> Médico: ${medicoNombre}</p>
                </div>
              </div>`;
            });
            html += '</div>';
            showCardResult(html, true); // --- MODIFICADO ---
          } else {
            showResult('read-result', `Error: ${result.message}`, false);
          }
        } catch (error) {
          showResult('read-result', `Error de conexión: ${error.message}`, false);
        }
      }

      async function loadTurnosDropdown(idSelect) {
        try {
          const response = await fetch('/api/turnos');
          const result = await response.json();
          
          if (!response.ok || !Array.isArray(result.data)) return;

          // Asegura que los nombres estén
          await ensurePacientesLoaded();
          await ensureMedicosLoaded();

          const select = document.getElementById(idSelect);
          select.innerHTML = '<option value="">Seleccionar turno...</option>';
          
          result.data.forEach(turno => {
            const medico = medicos.find(m => (m._id || m.IdMedico) == turno.IdMedico);
            const paciente = pacientes.find(p => (p._id || p.IdPaciente) == turno.IdPaciente);
            turno.Medico = medico ? medico.Nombre + ' ' + medico.Apellido : 'N/A';
            turno.Paciente = paciente ? paciente.Nombre + ' ' + paciente.Apellido : 'N/A';
            
            const option = document.createElement('option');
            option.value = turno._id;
            option.textContent = `${formatDate(turno.Fecha)} ${turno.HoraInicio || ''} | ${turno.Paciente} - ${turno.Medico}`;
            select.appendChild(option);
          });
        } catch (error) {
          console.error('Error cargando turnos:', error);
        }
      }

      async function getTurnosByPaciente() {
        const idPaciente = document.getElementById('searchPaciente').value;
        if (!idPaciente) {
          showResult('read-result', 'Por favor seleccione un paciente', false);
          return;
        }
        getTurnosByPacienteId(idPaciente); // Reutiliza la función
      }

      async function getTurnosByPacienteId(idPaciente) {
        try {
          await ensureMedicosLoaded();
          await ensurePacientesLoaded();
          const response = await fetch(`/api/turnos/paciente/${idPaciente}`);
          const result = await response.json();
          if (response.ok) {
            const paciente = pacientes.find(p => (p._id || p.IdPaciente) == idPaciente);
            const pacienteNombre = paciente ? paciente.Nombre + ' ' + paciente.Apellido : 'Paciente';
            let html = `<h4><i class="fas fa-user-injured"></i> Turnos de ${pacienteNombre}:</h4><div class="cards-grid">`;
            if (!result.data.length) {
              html += '<p>No hay turnos para este paciente.</p>';
            }
            result.data.forEach(turno => {
              const medico = medicos.find(m => (m._id || m.IdMedico) == turno.IdMedico);
              const medicoNombre = medico ? medico.Nombre + ' ' + medico.Apellido : 'N/A';
              html += `<div class="card turno-card" onclick="selectTurnoCard(this)" data-fecha="${formatDate(turno.Fecha)}" data-hora-inicio="${turno.HoraInicio || ''}" data-hora-fin="${turno.HoraFin || ''}" data-paciente="${pacienteNombre}" data-medico="${medicoNombre}">
                <div class="card-header">
                  <i class="fas fa-calendar-check"></i>
                  <div class="card-title">${formatDate(turno.Fecha)} ${turno.HoraInicio || ''}-${turno.HoraFin || ''}</div>
                </div>
                <div class="card-body">
                  <p><i class="fas fa-user-injured"></i> Paciente: ${pacienteNombre}</p>
                  <p><i class="fas fa-user-md"></i> Médico: ${medicoNombre}</p>
                </div>
              </div>`;
            });
            html += '</div>';
            showCardResult(html, true); // --- MODIFICADO ---
          } else {
            showResult('read-result', `Error: ${result.message}`, false);
          }
        } catch (error) {
          showResult('read-result', `Error de conexión: ${error.message}`, false);
        }
      }

      async function getTurnosByMedico() {
        const idMedico = document.getElementById('searchMedico').value;
        if (!idMedico) {
          showResult('read-result', 'Por favor seleccione un médico', false);
          return;
        }
        getTurnosByMedicoId(idMedico); // Reutiliza la función
      }

      async function getTurnosByMedicoId(idMedico) {
        try {
          await ensureMedicosLoaded();
          await ensurePacientesLoaded();
          const response = await fetch(`/api/turnos/medico/${idMedico}`);
          const result = await response.json();
          if (response.ok) {
            const medico = medicos.find(m => (m._id || m.IdMedico) == idMedico);
            const medicoNombre = medico ? medico.Nombre + ' ' + medico.Apellido : 'Médico';
            let html = `<h4><i class="fas fa-user-md"></i> Turnos de ${medicoNombre}:</h4><div class="cards-grid">`;
            if (!result.data.length) {
              html += '<p>No hay turnos para este médico.</p>';
            }
            result.data.forEach(turno => {
              const paciente = pacientes.find(p => (p._id || p.IdPaciente) == turno.IdPaciente);
              const pacienteNombre = paciente ? paciente.Nombre + ' ' + paciente.Apellido : 'N/A';
              html += `<div class="card turno-card" onclick="selectTurnoCard(this)" data-fecha="${formatDate(turno.Fecha)}" data-hora-inicio="${turno.HoraInicio || ''}" data-hora-fin="${turno.HoraFin || ''}" data-paciente="${pacienteNombre}" data-medico="${medicoNombre}">
                <div class="card-header">
                  <i class="fas fa-calendar-check"></i>
                  <div class="card-title">${formatDate(turno.Fecha)} ${turno.HoraInicio || ''}-${turno.HoraFin || ''}</div>
                </div>
                <div class="card-body">
                  <p><i class="fas fa-user-injured"></i> Paciente: ${pacienteNombre}</p>
                  <p><i class="fas fa-user-md"></i> Médico: ${medicoNombre}</p>
                </div>
              </div>`;
            });
            html += '</div>';
            showCardResult(html, true); // --- MODIFICADO ---
          } else {
            showResult('read-result', `Error: ${result.message}`, false);
          }
        } catch (error) {
          showResult('read-result', `Error de conexión: ${error.message}`, false);
        }
      }

      async function loadTurnoData() {
        const id = document.getElementById('updateTurnoSelect').value;
        if (!id) {
          showResult('update-result', 'Por favor seleccione un turno', false);
          return;
        }
        try {
          const response = await fetch(`/api/turnos/${id}`);
          const result = await response.json();
          if (response.ok) {
            const t = result.data;
            document.getElementById('updateFecha').value = t.Fecha.split('T')[0];
            document.getElementById('updateHoraInicio').value = t.HoraInicio;
            document.getElementById('updateHoraFin').value = t.HoraFin;
            document.getElementById('updateIdPaciente').value = t.IdPaciente;
            document.getElementById('updateIdMedico').value = t.IdMedico;
            document.getElementById('update-data-form').style.display = 'block';
            showResult('update-result', 'Datos cargados correctamente', true);
          } else {
            showResult('update-result', `Error: ${result.message}`, false);
          }
        } catch (error) {
          showResult('update-result', `Error de conexión: ${error.message}`, false);
        }
      }

      async function updateTurno(event) {
        event.preventDefault();
        const id = document.getElementById('updateTurnoSelect').value;
        const formData = new FormData(event.target);
        const data = {
          Fecha: formData.get('updateFecha'),
          HoraInicio: formData.get('updateHoraInicio'),
          HoraFin: formData.get('updateHoraFin'),
          IdPaciente: formData.get('updateIdPaciente'),
          IdMedico: formData.get('updateIdMedico')
        }
        if (!validateDateTime(data.Fecha, data.HoraInicio)) {
          showResult('update-result', 'La fecha y hora del turno deben ser posteriores al momento actual', false);
          return;
        }
        try {
          const response = await fetch(`/api/turnos/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          const result = await response.json();
          if (response.ok) {
            showResult('update-result', 'Turno actualizado exitosamente', true);
            loadTurnosDropdown('updateTurnoSelect');
            loadTurnosDropdown('deleteTurnoSelect');
          } else {
            showResult('update-result', `Error: ${result.message}`, false);
          }
        } catch (error) {
          showResult('update-result', `Error de conexión: ${error.message}`, false);
        }
      }

      async function deleteTurnoFromSelect() {
        const id = document.getElementById('deleteTurnoSelect').value;
        if (!id) {
          showResult('delete-result', 'Por favor seleccione un turno para eliminar', false);
          return;
        }
        if (!confirm('¿Está seguro de que desea eliminar este turno?')) {
          return;
        }
        try {
          const response = await fetch(`/api/turnos/${id}`, {
            method: 'DELETE'
          });
          const result = await response.json();
          if (response.ok) {
            showResult('delete-result', 'Turno eliminado exitosamente', true);
            loadTurnosDropdown('updateTurnoSelect');
            loadTurnosDropdown('deleteTurnoSelect');
          } else {
            showResult('delete-result', `Error: ${result.message}`, false);
          }
        } catch (error) {
          showResult('delete-result', `Error de conexión: ${error.message}`, false);
        }
      }

      async function logout(){
        try {
          const response = await fetch('/api/auth/logout', { method: 'POST' });
          const data = await response.json();
          if (response.ok) {
            localStorage.removeItem('authToken');
            window.location.href = '/login';
          } else {
            alert(data.message || 'Error al cerrar sesión');
          }
        } catch (e) {
          alert('Error de conexión: ' + e.message);
        }
      }

      // --- MODIFICADO: Muestra la tarjeta seleccionada en el contenedor ---
      function selectTurnoCard(el) {
        try {
          const fecha = el.dataset.fecha || '';
          const horaInicio = el.dataset.horaInicio || '';
          const horaFin = el.dataset.horaFin || '';
          const paciente = el.dataset.paciente || 'N/A';
          const medico = el.dataset.medico || 'N/A';
          const html = `<h4><i class="fas fa-check-circle"></i> Turno Seleccionado:</h4>
            <div class="cards-grid" style="grid-template-columns: 1fr;">
              <div class="card">
                <div class="card-header">
                  <i class="fas fa-calendar-check"></i>
                  <div class="card-title">${fecha} ${horaInicio}-${horaFin}</div>
                </div>
                <div class="card-body">
                  <p><i class="fas fa-user-injured"></i> Paciente: ${paciente}</p>
                  <p><i class="fas fa-user-md"></i> Médico: ${medico}</p>
                </div>
              </div>
            </div>`;
          showCardResult(html, true); // --- MODIFICADO ---
        } catch (e) {
          console.error('Error al mostrar detalle del turno:', e);
        }
      }